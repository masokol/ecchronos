description: A workload using key value in a messaging fashion, records that has been read are deleted.

scenarios:
  default:
    schema: run driver=cql tags==phase:schema threads==1 cycles==UNDEF
    main: run driver=cql tags==phase:main cycles===<<main-cycles,1000000>> threads=auto cyclerate=1000,1.5
  long-running:
    schema: run driver=cql tags==phase:schema threads==1 cycles==UNDEF
    main: run driver=cql tags==phase:main cycles===<<main-cycles,100000000>> threads=auto cyclerate=1000,1.5

bindings:
  # For reads, writes and deletes
  # Div(3L) to have the same key and id for 3 cycles (i.e 1 insert, 1 select and 1 delete)
  rw_key: Div(3L); HashRangeScaled(TEMPLATE(scalefactor,1.0d)); ToString();
  rw_id: Div(3L); Hash(); HashRangeScaled(TEMPLATE(scalefactor,1.0d)); ToString();
  rw_value: ByteBufferSizedHashed(<<valuedist:Uniform(0,10000)>>);

blocks:
  - name: schema
    tags:
      phase: schema
    params:
      prepared: false
    statements:
    - create-keyspace: |
        create keyspace if not exists <<keyspace:benchkeyspace>>
        WITH replication = {'class': 'SimpleStrategy', 'replication_factor': '<<rf:3>>'}
        AND durable_writes = true;
      tags:
         name: create-keyspace
    - create-table: |
        create table if not exists <<keyspace:benchkeyspace>>.<<table:messaging>> (
        key text,
        id text,
        value blob,
        PRIMARY KEY(key, id))
        WITH CLUSTERING ORDER BY (id ASC);
      tags:
        name: create-table
  # Order here matters, we want this order: insert -> select -> delete (to simulate a real user)
  - name: main-write
    tags:
      phase: main
      type: write
    params:
      ratio: 1
      cl: <<write_cl:LOCAL_QUORUM>>
    statements:
      - main-insert: |
          insert into <<keyspace:benchkeyspace>>.<<table:messaging>>
          (key, id, value) values ({rw_key}, {rw_id}, {rw_value});
        tags:
          name: main-insert
  - name: main-read-delete
    tags:
      phase: main
      type: read-delete
    params:
      ratio: 1
      cl: <<read_cl:LOCAL_QUORUM>>
    statements:
      - main-select: |
          select * from <<keyspace:benchkeyspace>>.<<table:messaging>> where key={rw_key} and id={rw_id};
        tags:
          name: main-select
      - main-delete: |
          delete from <<keyspace:benchkeyspace>>.<<table:messaging>> where key={rw_key} and id={rw_id};
        tags:
          name: main-delete
